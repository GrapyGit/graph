<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.plot.ly/plotly-2.12.1.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-locale-ru-latest.js"></script>
    <title>test</title>
    <style>
        html{
            width: 100%;
            height: 100%;
        }
        body{
            width: 100%;
            height: 100%;
            margin: 0%;
        }
        #tester{
            width: 100%;
            height: 100%;
            margin: 0%;
            display: block;
            font-family: cursive;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="tester"></div>
    <script>
var trace = {
  x: ['2013-10-04','2013-10-05'],
  y: [],
  mode:'lines',
  name: "План добычи",
  fill: 'tozeroy',
  fillcolor: 'rgba(220, 238, 254, 0.5)',
  marker: {
        color: 'dceefe',
        opacity: 0.2
    },
    line: {
        color: '74bafc',
     width: 2,
  },
};
var trace1 = {
  x: [],
  y:[],
  mode: 'lines+markers',
  name: 'Добыто (сутки)',
  type: 'scatter',
  hover_name : "Добыто (сутки)",
  line: {color: "red", width: 3, shape: 'linear'},
  hovertemplate :'%{x} <br>' + 'Добыто(сутки): %{y}' +"<extra></extra>"
  ,

  hoverlabel : {
      bgcolor: 'white',
      bordercolor: 'red'
  }

};
var trace2 = {
  x: [
  new Date("2013-10-04 00:00:00"),  new Date("2013-10-04 01:00:00"),  new Date("2013-10-04 02:00:00"),  new Date("2013-10-04 03:00:00"),  new Date("2013-10-04 04:00:00"),
  new Date("2013-10-04 05:00:00"),  new Date("2013-10-04 06:00:00"),  new Date("2013-10-04 07:00:00"),  new Date("2013-10-04 08:00:00"),  new Date("2013-10-04 09:00:00"),
  new Date("2013-10-04 10:00:00"),  new Date("2013-10-04 11:00:00"),  new Date("2013-10-04 12:00:00"),  new Date("2013-10-04 13:00:00"),  new Date("2013-10-04 14:00:00"),
  new Date("2013-10-04 15:00:00"),  new Date("2013-10-04 16:00:00"),  new Date("2013-10-04 17:00:00"),  new Date("2013-10-04 18:00:00"),  new Date("2013-10-04 19:00:00"),
  new Date("2013-10-04 20:00:00"),  new Date("2013-10-04 21:00:00"),  new Date("2013-10-04 22:00:00"),  new Date("2013-10-04 23:00:00"),  new Date("2013-10-04 24:00:00"),
  ],
  y:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    type: 'bar',
    name: 'Добыто (час)',
    marker: {
        color: '8eed84',
        width: 10
    },
    hovertemplate :'%{x}  <br>' + 'Добыто (час): %{y}' +"<extra></extra>",
  hoverlabel : {
      bgcolor: 'white',
      bordercolor: 'green'
  }
};
var trace3 = {

 x: [new Date('2013-10-04 00:00:00'), new Date('2013-10-04 23:59:00')],
 
  y:[0,0],
  mode: 'lines',
  name: 'Прогноз добычи',
  line: {color: "black", width: 3,  dash: 'dot'},

}
var config = {
    locale: 'ru',
    displayModeBar: false,
    responsive: true,
    showlegend: true
}

var data = [trace,trace3,trace1,trace2];
        layout = {
            hovermode:'closest',
            title: 'Скважина 1-1',
            font:{size:16, family: "cursive"},
            xaxis: {
               range: [new Date('2013-10-04 00:00:00'), new Date('2013-10-05 00:00:00')],
                type: 'date',
                tickmode: "linear", 
                tick0: '2013-10-04',
                dtick:  2 * 60 * 60 * 1000, 
                showgrid: false,
                zeroline: true
            },
            yaxis: {
                automargin: true,
                ticksuffix: "тыс.м",
                title: 'Дeбыто',
                showline: false
            },
            legend: {
            orientation : "h",
            y: -0.1,
            x: 0.4,
            traceorder: 'reversed',
            font: {
                size: 16,
                family: "monospace"
            }
        },
        annotations: [
    {
      x: "",
      y: 0,
      xref: 'x',
      yref: 'y',
      text: '',
    },
    {
      x: "",
      y: 0,
      xref: 'x',
      yref: 'y',
      text: '',
    }
  ]
    }
        graphDiv = document.getElementById('tester');

      Plotly.newPlot( graphDiv, data,layout,config);

function setPlane(value){
trace.y = [value,value]
data[0] = trace
console.log(data)
Plotly.newPlot( graphDiv, data, layout,config);
}
function setValue(value, times){
times= new Date(times)
var a = new Array(24).fill(0), n =0, j =0
    for (i=0;i<trace1.x.length;i++){
        if (trace1.x[i]>times){
          break;
      }
    }
    trace1.x.splice(i, 0 , times);
    trace1.y.splice(i, 0 , value)
    data[2] =  trace1
    trace3.x[0] = trace1.x[trace1.x.length-1]
    trace3.y[0] = trace1.y[trace1.y.length-1]
    for (i=0;i<trace1.x.length;i++){
      while(trace1.x[i].getHours() !=n && n!=24) n++
         a[n]= trace1.y[i]
   }

console.log("прколы     " + a)

    for(i=0; i<=24; i++){
      if (a[i]){
          trace2.y[i] = a[i]-j
       j = a[i]           
      }
    }
    console.log("прколы 2   " + a)
    
    let da =new  Date(trace1.x[trace1.x.length-1])
   trace3.y[1] = Math.round(trace1.y[trace1.y.length-1] + (trace1.y[trace1.y.length-1]/da.getHours())*(24 - da.getHours()))
   layout.annotations[0].x =  trace3.x[0]
   layout.annotations[0].text = trace3.y[0]
   layout.annotations[0].y =  trace3.y[0]
   layout.annotations[1].x =  trace3.x[1]
   layout.annotations[1].y =  trace3.y[1]
   layout.annotations[1].text = trace3.y[1]
  //  Plotly.newPlot( graphDiv, data,layout,config);
    Plotly.react(graphDiv, data);
}

setValue(30, "2013-10-04 04:34:00");
setValue(40, "2013-10-04 04:55:00");
setValue(50, "2013-10-04 05:13:00");
setValue(60, "2013-10-04 07:40:00");
setValue(127, "2013-10-04 18:40:00");
setValue(10, "2013-10-04 02:34:00");
setValue(55, "2013-10-04 05:30:00");
setValue(120, "2013-10-04 18:13:00");
setValue(15, "2013-10-04 03:13:00");
setValue(80,"2013-10-04 08:40:00");
setValue(79, "2013-10-04 07:40:00");
setValue(101, "2013-10-04 11:34:00");
setValue(100, "2013-10-04 11:30:00");
setValue(88, "2013-10-04 09:13:00");
setPlane(140)
    </script>
</body>
</html>
